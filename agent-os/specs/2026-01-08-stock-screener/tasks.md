# タスク分解: 銘柄スクリーニングツール

## 概要
総タスク数: 54個のサブタスク
実装順序: プロジェクトセットアップ → データベース層 → API層 → 外部API連携 → フロントエンド → テスト

## タスクリスト

### プロジェクトセットアップ

#### タスクグループ1: 初期環境構築
**依存関係:** なし

- [ ] 1.0 プロジェクトの初期セットアップを完了
  - [ ] 1.1 プロジェクトディレクトリ構造を作成
    - フロントエンド用ディレクトリ（React等）
    - バックエンド用ディレクトリ（Python/Node.js等）
    - 共有設定ファイル用ディレクトリ
  - [ ] 1.2 フロントエンドの初期化
    - パッケージマネージャーの初期化（npm/yarn）
    - 必要な依存パッケージのインストール（React、Axios等）
    - 開発サーバーの起動確認
  - [ ] 1.3 バックエンドの初期化
    - パッケージマネージャーの初期化（pip/npm）
    - 必要な依存パッケージのインストール（yfinance、Flask/Express等）
    - 開発サーバーの起動確認
  - [ ] 1.4 環境変数設定ファイルを作成
    - `.env.example`ファイルの作成
    - APIキー、データベース接続情報等の定義
    - `.gitignore`に`.env`を追加
  - [ ] 1.5 データベース接続設定
    - データベース（PostgreSQL/MySQL等）のセットアップ
    - ORM/クエリビルダーの設定
    - 接続テストの実行

**受け入れ基準:**
- フロントエンド・バックエンドの開発サーバーが正常に起動する
- データベース接続が確立される
- 環境変数が正しく読み込まれる

### データベース層

#### タスクグループ2: データモデルとマイグレーション
**依存関係:** タスクグループ1

- [ ] 2.0 データベース層を完了
  - [ ] 2.1 Stockモデルの2〜8個の絞り込んだテストを作成
    - 最大2〜8個の非常に絞り込んだテストに制限
    - 重要なモデルの動作のみをテスト（例：主要なバリデーション、キー関連、コアメソッド）
    - すべてのメソッドとエッジケースの網羅的なカバレッジはスキップ
  - [ ] 2.2 Stockモデルをバリデーション付きで作成
    - フィールド: ticker（主キー、文字列）、name（文字列、NOT NULL）、market（文字列、NOT NULL、値: 'JP' or 'US'）
    - フィールド: sector（文字列）、market_cap（BIGINT）、per（DECIMAL）、pbr（DECIMAL）
    - フィールド: roe（DECIMAL）、dividend_yield（DECIMAL）、price（DECIMAL）、currency（文字列、値: 'JPY' or 'USD'）
    - フィールド: last_updated（TIMESTAMP、NOT NULL）、created_at（TIMESTAMP）、updated_at（TIMESTAMP）
    - バリデーション: ticker、name、marketは必須
    - バリデーション: 数値フィールドは正の数のみ許可
    - バリデーション: 最小値が最大値を超えないこと
  - [ ] 2.3 Stockテーブルのマイグレーションを作成
    - 上記のすべてのフィールドを含むテーブルを作成
    - tickerフィールドを主キーとして設定
    - market、sectorにインデックスを追加
    - market_cap、per、pbr、roe、dividend_yield、priceにインデックスを追加（検索パフォーマンス向上）
  - [ ] 2.4 マイグレーションを実行してデータベースに反映
    - マイグレーションの実行
    - テーブル作成の確認
    - インデックスが正しく設定されているか確認
  - [ ] 2.5 データベース層のテストが通ることを確認
    - 2.1で作成した2〜8個のテストのみを実行
    - マイグレーションが正常に実行されることを確認
    - この段階では全テストスイートを実行しない

**受け入れ基準:**
- 2.1で作成した2〜8個のテストがパスする
- モデルがバリデーションテストをパスする
- マイグレーションが正常に実行される
- インデックスが適切に設定されている

### API層

#### タスクグループ3: RESTful APIエンドポイント
**依存関係:** タスクグループ2

- [ ] 3.0 API層を完了
  - [ ] 3.1 APIエンドポイントの2〜8個の絞り込んだテストを作成
    - 最大2〜8個の非常に絞り込んだテストに制限
    - 重要なコントローラーアクションのみをテスト（例：主要なCRUD操作、認証チェック、キーエラーケース）
    - すべてのアクションとシナリオの網羅的なテストはスキップ
  - [ ] 3.2 スクリーニングAPIエンドポイントを作成: `GET /api/v1/stocks/screen`
    - クエリパラメータを受け取る: market、marketCapMin、marketCapMax、perMin、perMax等
    - データベースから条件に合致する銘柄をフィルタリング
    - ページネーション機能を実装（デフォルト50件/ページ）
    - ソート機能を実装（クエリパラメータ: sortBy、sortOrder）
    - JSON形式でレスポンスを返却: { stocks: [], totalCount: number, page: number, pageSize: number }
  - [ ] 3.3 業種リスト取得APIエンドポイントを作成: `GET /api/v1/sectors`
    - クエリパラメータ: market（JP/US）
    - 指定された市場の業種リストを返却
    - JSON形式: { sectors: [] }
  - [ ] 3.4 データ更新APIエンドポイントを作成: `POST /api/v1/stocks/refresh`
    - 非同期処理でYahoo Finance APIからデータを取得
    - 処理状況を返却（処理中、完了、エラー）
    - JSON形式: { status: string, message: string, lastUpdated: datetime }
  - [ ] 3.5 入力バリデーションを実装
    - 最小値が最大値を超えていないか検証
    - 数値フィールドに文字列が入力されていないか検証
    - 不正なmarketパラメータ（JP/US以外）を拒否
    - バリデーションエラー時は400エラーと明確なエラーメッセージを返却
  - [ ] 3.6 レート制限を実装
    - IPアドレスごとに1分あたり60リクエストまで
    - 制限超過時は429エラーを返却
    - レスポンスヘッダーに残りリクエスト数を含める
  - [ ] 3.7 エラーハンドリングを実装
    - 適切なHTTPステータスコードを返却（200、201、400、404、429、500）
    - エラーレスポンスの統一フォーマット: { error: string, message: string, statusCode: number }
    - すべてのエラーをサーバーログに記録
  - [ ] 3.8 API層のテストが通ることを確認
    - 3.1で作成した2〜8個のテストのみを実行
    - 重要なCRUD操作が動作することを確認
    - この段階では全テストスイートを実行しない

**受け入れ基準:**
- 3.1で作成した2〜8個のテストがパスする
- すべてのCRUD操作が動作する
- 適切な認可が実施される
- 一貫したレスポンスフォーマット

### 外部API連携

#### タスクグループ4: Yahoo Finance API統合とキャッシング
**依存関係:** タスクグループ3

- [ ] 4.0 外部API連携を完了
  - [ ] 4.1 yfinanceライブラリまたはサードパーティAPIの設定
    - yfinanceライブラリのインストール（Pythonの場合）
    - または、RapidAPI等のYahoo Finance APIの設定
    - APIキーの環境変数設定（サードパーティAPIの場合）
    - 接続テストの実行
  - [ ] 4.2 銘柄データ取得サービスを作成
    - 単一銘柄のデータを取得する関数
    - ティッカーシンボルを入力として受け取る
    - 財務指標（時価総額、PER、PBR、ROE、配当利回り、株価）を取得
    - セクター情報を取得
    - エラーハンドリング（存在しないティッカー、API接続エラー等）
  - [ ] 4.3 バッチ処理スクリプトを作成
    - 主要銘柄リスト（日経225、S&P 500）を定義
    - 各銘柄のデータをYahoo Finance APIから取得
    - データベースに保存（upsert処理）
    - リクエスト間隔の制御（レート制限対策）
    - 進捗状況のログ出力
    - エラー時のリトライ機構（指数バックオフで最大3回）
  - [ ] 4.4 キャッシング機構を実装
    - 最終更新日時をチェック
    - 一定時間内（例：24時間）はキャッシュデータを使用
    - キャッシュ期限切れの場合のみAPIリクエスト
    - 最終更新日時をデータベースに記録
  - [ ] 4.5 エラーハンドリングとリトライ機構を実装
    - API接続エラー時の適切なエラーメッセージ
    - タイムアウト設定（30秒）
    - 一時的な失敗時のリトライ（指数バックオフで3回まで）
    - すべてのエラーをログに記録

**受け入れ基準:**
- yfinanceライブラリまたはサードパーティAPIが正常に動作する
- 銘柄データが正しく取得される
- バッチ処理が正常に完了する
- キャッシング機構が適切に動作する
- エラーハンドリングが適切に実装されている

### フロントエンド層

#### タスクグループ5: UIコンポーネント設計
**依存関係:** タスクグループ4

- [ ] 5.0 UIコンポーネントを完了
  - [ ] 5.1 UIコンポーネントの2〜8個の絞り込んだテストを作成
    - 最大2〜8個の非常に絞り込んだテストに制限
    - 重要なコンポーネントの動作のみをテスト（例：主要なユーザーインタラクション、キーフォーム送信、主要なレンダリングケース）
    - すべてのコンポーネント状態とインタラクションの網羅的なテストはスキップ
  - [ ] 5.2 タブコンポーネントを作成
    - Props: activeTab（'JP' or 'US'）、onTabChange（関数）
    - タブクリック時にonTabChange関数を呼び出し
    - アクティブなタブを視覚的に強調
    - 再利用可能な汎用タブコンポーネントとして設計
  - [ ] 5.3 範囲指定入力コンポーネントを作成（RangeInput）
    - Props: label（文字列）、minValue、maxValue、onChange（関数）、unit（文字列、オプション）
    - 最小値・最大値の入力フィールドを横並びで配置
    - クライアントサイドバリデーション（最小値 < 最大値）
    - エラー表示機能
    - 再利用可能な汎用コンポーネントとして設計
  - [ ] 5.4 マルチセレクトコンポーネントを作成（MultiSelect）
    - Props: options（配列）、selectedValues（配列）、onChange（関数）、label（文字列）
    - チェックボックス形式またはドロップダウン形式
    - 複数選択可能
    - 選択解除機能
    - 再利用可能な汎用コンポーネントとして設計
  - [ ] 5.5 データテーブルコンポーネントを作成（DataTable）
    - Props: columns（配列）、data（配列）、onSort（関数）、sortBy（文字列）、sortOrder（文字列）
    - 列ヘッダークリックでソート機能（昇順/降順の切り替え）
    - ソートインジケーター（矢印アイコン等）の表示
    - 数値データの適切なフォーマット（桁区切り、小数点以下桁数）
    - 空データ時のメッセージ表示
    - 再利用可能な汎用コンポーネントとして設計
  - [ ] 5.6 ページネーションコンポーネントを作成（Pagination）
    - Props: totalCount、currentPage、pageSize、onPageChange（関数）
    - ページ番号の表示と選択
    - 前へ・次へボタン
    - 現在のページを視覚的に強調
    - 総ページ数の表示
    - 再利用可能な汎用コンポーネントとして設計
  - [ ] 5.7 ローディングインジケーターコンポーネントを作成
    - スピナーまたはプログレスバー
    - メッセージ表示機能（オプション）
    - 再利用可能な汎用コンポーネントとして設計
  - [ ] 5.8 UIコンポーネントのテストが通ることを確認
    - 5.1で作成した2〜8個のテストのみを実行
    - 重要なコンポーネントの動作が正常に動作することを確認
    - この段階では全テストスイートを実行しない

**受け入れ基準:**
- 5.1で作成した2〜8個のテストがパスする
- コンポーネントが正しくレンダリングされる
- フォームがバリデーションと送信を行う
- ビジュアルデザインと一致する

#### タスクグループ6: メインページ実装
**依存関係:** タスクグループ5

- [ ] 6.0 メインページを完了
  - [ ] 6.1 ヘッダーセクションを実装
    - タイトル「銘柄スクリーニングツール」を表示
    - 最終更新日時の表示
    - データ更新ボタンの配置
    - 更新ボタンクリック時にPOST /api/v1/stocks/refreshを呼び出し
    - ローディング状態の表示
  - [ ] 6.2 市場選択タブを実装
    - タブコンポーネント（タスク5.2）を使用
    - 日本株/米国株の切り替え
    - タブ切り替え時にフィルタ条件をリセット
    - 選択中の市場をステート管理
  - [ ] 6.3 フィルタフォームを実装
    - 時価総額のRangeInputコンポーネント（タスク5.3）
    - PER、PBR、ROEのRangeInputコンポーネント
    - 配当利回り、株価のRangeInputコンポーネント
    - 業種・セクターのMultiSelectコンポーネント（タスク5.4）
    - 「検索」ボタンの実装
    - 「クリア」ボタンの実装（全条件リセット）
    - クライアントサイドバリデーション
    - エラーメッセージの表示
  - [ ] 6.4 検索結果テーブルを実装
    - DataTableコンポーネント（タスク5.5）を使用
    - 列: ティッカー、銘柄名、セクター、時価総額、PER、PBR、ROE、配当利回り、株価
    - ソート機能の統合（クリック時にAPIリクエスト）
    - 数値の適切なフォーマット（桁区切り、小数点以下桁数、通貨記号）
    - 総件数の表示（例：「検索結果：123件」）
    - 検索結果0件時のメッセージ表示
  - [ ] 6.5 ページネーションを実装
    - Paginationコンポーネント（タスク5.6）を使用
    - ページ切り替え時にAPIリクエスト
    - 現在のページをURL状態として管理（オプション）
  - [ ] 6.6 APIとの連携を実装
    - Axiosまたはfetch APIを使用
    - GET /api/v1/stocks/screenエンドポイントへのリクエスト
    - GET /api/v1/sectorsエンドポイントへのリクエスト（業種リスト取得）
    - POST /api/v1/stocks/refreshエンドポイントへのリクエスト（データ更新）
    - ローディング状態の管理
    - エラーハンドリング
    - エラーメッセージの表示
  - [ ] 6.7 フッターセクションを実装
    - 免責事項の表示：「本ツールは投資助言ではありません。投資判断は自己責任で行ってください」
    - データソースの明示：「データソース：Yahoo Finance API」
    - データ精度の限界についての注意書き
    - 著作権表示

**受け入れ基準:**
- ヘッダー、タブ、フィルタフォーム、結果テーブル、フッターが正しく表示される
- タブ切り替えが正常に動作する
- フィルタフォームの入力とバリデーションが動作する
- 検索結果が正しく表示される
- ソートとページネーションが動作する
- APIとの連携が正常に動作する

#### タスクグループ7: スタイリングとレスポンシブデザイン
**依存関係:** タスクグループ6

- [ ] 7.0 スタイリングとレスポンシブデザインを完了
  - [ ] 7.1 ベーススタイルを適用
    - グローバルCSSの設定（リセットCSS、フォント設定等）
    - カラースキームの定義（プライマリカラー：ビジネス向けのブルー系）
    - タイポグラフィの設定（見出し、本文、等幅フォント等）
    - 既存のデザインシステムに従う
  - [ ] 7.2 各コンポーネントのスタイルを実装
    - ヘッダーのスタイル（背景色、余白、配置）
    - タブのスタイル（アクティブ状態の視覚的強調）
    - フィルタフォームのスタイル（白背景、グレーボーダー、余白）
    - ボタンのスタイル（プライマリカラー、ホバー状態、クリック状態）
    - テーブルのスタイル（ボーダー、交互行の背景色、ヘッダーの強調）
    - ページネーションのスタイル
    - エラーメッセージのスタイル（赤系）
    - 成功メッセージのスタイル（緑系）
  - [ ] 7.3 レスポンシブデザインを実装（デスクトップ：1024px以上）
    - フィルタフォームを左サイドバーに配置
    - 検索結果テーブルをメインコンテンツエリアに配置
    - 2カラムレイアウト
  - [ ] 7.4 レスポンシブデザインを実装（タブレット：768px〜1024px）
    - フィルタフォームを折りたたみ可能に（アコーディオン）
    - テーブルの列幅を調整
    - 1カラムレイアウト
  - [ ] 7.5 レスポンシブデザインを実装（モバイル：320px〜768px）
    - フィルタフォームをアコーディオン形式で折りたたみ
    - テーブルを横スクロール対応に変更
    - タッチ操作を考慮したUI要素のサイズ設定（最小タップ領域：44x44px）
    - フォントサイズの調整（最小14px以上）
    - 1カラムレイアウト
  - [ ] 7.6 インタラクションとアニメーションを追加
    - ボタンのホバー状態（色の変化、影の追加等）
    - タブ切り替えのトランジション
    - テーブルソートのアニメーション
    - ローディングスピナーのアニメーション
    - フォーム入力のフォーカス状態
    - エラーメッセージのフェードイン/アウト

**受け入れ基準:**
- すべてのコンポーネントが適切にスタイリングされている
- デスクトップ、タブレット、モバイルでレイアウトが正しく表示される
- インタラクションとアニメーションが滑らかに動作する
- タッチ操作が快適に行える（モバイル）
- アクセシビリティが確保されている（フォントサイズ、タップ領域等）

### テスト

#### タスクグループ8: テストレビューとギャップ分析
**依存関係:** タスクグループ1〜7

- [ ] 8.0 既存テストのレビューと重要なギャップのみ埋める
  - [ ] 8.1 タスクグループ1〜7のテストをレビュー
    - データベースエンジニアが作成した2〜8個のテスト（タスク2.1）をレビュー
    - APIエンジニアが作成した2〜8個のテスト（タスク3.1）をレビュー
    - UIデザイナーが作成した2〜8個のテスト（タスク5.1）をレビュー
    - 既存テスト総数: 約6〜24個のテスト
  - [ ] 8.2 この機能のみのテストカバレッジギャップを分析
    - テストカバレッジが欠けている重要なユーザーワークフローを特定
    - この仕様の機能要件に関連するギャップのみに焦点を当てる
    - アプリケーション全体のテストカバレッジは評価しない
    - ユニットテストギャップよりもエンドツーエンドワークフローを優先
  - [ ] 8.3 最大10個の戦略的なテストを追加
    - 特定された重要なギャップを埋めるため、最大10個の新しいテストを追加
    - 統合ポイントとエンドツーエンドワークフローに焦点を当てる
    - すべてのシナリオの包括的なカバレッジは書かない
    - ビジネスクリティカルでない限り、エッジケース、パフォーマンステスト、アクセシビリティテストはスキップ
    - 推奨テスト例:
      - エンドツーエンド: 市場選択 → フィルタ条件入力 → 検索 → 結果表示 → ソート → ページネーション
      - 統合: APIエンドポイント → データベースクエリ → レスポンス整形
      - 統合: Yahoo Finance API → データ取得 → データベース保存
      - 統合: フィルタフォーム送信 → APIリクエスト → 結果表示
      - エラーハンドリング: API接続エラー時のユーザーフィードバック
  - [ ] 8.4 機能固有のテストのみを実行
    - この仕様の機能に関連するテストのみを実行（テスト2.1、3.1、5.1、8.3）
    - 予想される合計: 約16〜34個のテスト最大
    - アプリケーション全体のテストスイートは実行しない
    - 重要なワークフローがパスすることを確認

**受け入れ基準:**
- すべての機能固有のテストがパスする（合計約16〜34個のテスト）
- この機能の重要なユーザーワークフローがカバーされている
- テストギャップを埋める際に追加したテストが10個以下
- テストがこの仕様の機能要件のみに焦点を当てている

### デプロイメント準備

#### タスクグループ9: 本番環境準備
**依存関係:** タスクグループ8

- [ ] 9.0 本番環境準備を完了
  - [ ] 9.1 環境変数とシークレット管理
    - 本番用の環境変数を設定
    - APIキーのセキュアな管理
    - データベース接続情報の設定
    - 環境変数がリポジトリにコミットされていないことを確認
  - [ ] 9.2 パフォーマンス最適化
    - フロントエンドのビルド最適化（ミニファイ、バンドルサイズ削減）
    - 画像の最適化（圧縮、適切なフォーマット）
    - APIレスポンスの最適化（不要なデータの削除）
    - データベースクエリの最適化（インデックスの確認）
  - [ ] 9.3 セキュリティ対策
    - CORS設定の実装
    - SQLインジェクション対策の確認
    - XSS対策の確認
    - レート制限の確認
    - HTTPS設定の確認
  - [ ] 9.4 エラーログとモニタリング
    - エラーログの出力設定
    - ログレベルの設定（本番環境ではINFO以上）
    - エラートラッキングツールの設定（Sentry等、オプション）
    - パフォーマンスモニタリングの設定（オプション）
  - [ ] 9.5 ドキュメント作成
    - README.mdの作成（プロジェクト概要、セットアップ手順、使用方法）
    - API仕様書の作成（エンドポイント、パラメータ、レスポンス例）
    - デプロイ手順書の作成
    - トラブルシューティングガイドの作成

**受け入れ基準:**
- 環境変数が適切に設定されている
- パフォーマンスが最適化されている
- セキュリティ対策が実装されている
- エラーログとモニタリングが設定されている
- ドキュメントが作成されている

## 実行順序

推奨実装シーケンス:
1. プロジェクトセットアップ（タスクグループ1）
2. データベース層（タスクグループ2）
3. API層（タスクグループ3）
4. 外部API連携（タスクグループ4）
5. UIコンポーネント設計（タスクグループ5）
6. メインページ実装（タスクグループ6）
7. スタイリングとレスポンシブデザイン（タスクグループ7）
8. テストレビューとギャップ分析（タスクグループ8）
9. デプロイメント準備（タスクグループ9）

## 重要な注意事項

- **テスト駆動開発アプローチ**: 各タスクグループは2〜8個のテスト作成（x.1サブタスク）で開始し、それらのテストのみを実行（最終サブタスク）して終了
- **段階的なテスト実行**: 開発中は各グループのテストのみを実行し、全テストスイートは実行しない
- **再利用可能なコンポーネント設計**: タブ、RangeInput、MultiSelect、DataTable、Paginationコンポーネントは将来的に他の機能でも再利用可能な汎用設計とする
- **レート制限対策**: Yahoo Finance APIのレート制限を考慮し、キャッシング機構とバッチ処理を適切に実装する
- **エラーハンドリング**: すべてのレイヤーで適切なエラーハンドリングを実装し、ユーザーに明確なフィードバックを提供する
- **レスポンシブデザイン**: デスクトップ、タブレット、モバイルのすべてのデバイスで快適に使用できるUIを実装する
- **セキュリティ**: APIキーは環境変数で管理し、リポジトリにコミットしない
- **データ精度**: Yahoo Finance APIのデータ精度には限界があることを理解し、免責事項を明記する

## 技術スタック推奨

- **フロントエンド**: React、Axios、CSS Modules/Tailwind CSS
- **バックエンド**: Python（Flask/FastAPI）または Node.js（Express）
- **データベース**: PostgreSQL
- **外部API**: yfinanceライブラリ（Python）またはRapidAPI Yahoo Finance
- **テスト**: Jest（フロントエンド）、pytest（Python）またはJest（Node.js）

---

**タスク分解完了日:** 2026-01-08
**対象仕様:** 銘柄スクリーニングツール
**総タスク数:** 54個のサブタスク
**予想実装期間:** 2〜3週間（1名の開発者の場合）
