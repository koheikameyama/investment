# タスク分解: 銘柄スクリーニングツール

## 概要
総タスク数: 54個のサブタスク
実装順序: プロジェクトセットアップ → データベース層 → API層 → 外部API連携 → フロントエンド → テスト

**実装状況**: TypeScript版への移行完了（タスクグループ1-7実装済み）

## タスクリスト

### プロジェクトセットアップ

#### タスクグループ1: 初期環境構築（TypeScript）
**依存関係:** なし

- [x] 1.0 プロジェクトの初期セットアップを完了
  - [x] 1.1 プロジェクトディレクトリ構造を作成
    - フロントエンド用ディレクトリ（React + TypeScript + Vite）
    - バックエンド用ディレクトリ（TypeScript + Express）
    - 共有設定ファイル用ディレクトリ
  - [x] 1.2 フロントエンドの初期化
    - npm初期化完了
    - 必要な依存パッケージのインストール（React、TypeScript、Axios、Tailwind CSS等）
    - TypeScript設定ファイル作成
  - [x] 1.3 バックエンドの初期化
    - npm初期化完了
    - 必要な依存パッケージのインストール（Express、Prisma、yahoo-finance2等）
    - TypeScript設定ファイル作成
  - [x] 1.4 環境変数設定ファイルを作成
    - `.env.example`ファイルの作成
    - APIキー、データベース接続情報等の定義
    - `.gitignore`に`.env`を追加
  - [x] 1.5 データベース接続設定
    - Prismaの設定完了
    - データベース接続テスト用コード作成

**受け入れ基準:**
- フロントエンド・バックエンドの開発サーバーが正常に起動する
- データベース接続が確立される
- 環境変数が正しく読み込まれる

### データベース層

#### タスクグループ2: データモデルとマイグレーション（Prisma）
**依存関係:** タスクグループ1

- [x] 2.0 データベース層を完了
  - [ ] 2.1 Stockモデルの2〜8個の絞り込んだテストを作成
    - 最大2〜8個の非常に絞り込んだテストに制限
    - 重要なモデルの動作のみをテスト（例：主要なバリデーション、キー関連、コアメソッド）
    - すべてのメソッドとエッジケースの網羅的なカバレッジはスキップ
  - [x] 2.2 Stockモデルをバリデーション付きで作成
    - フィールド: ticker（主キー、文字列）、name（文字列、NOT NULL）、market（文字列、NOT NULL、値: 'JP' or 'US'）
    - フィールド: sector（文字列）、marketCap（BIGINT）、per（DECIMAL）、pbr（DECIMAL）
    - フィールド: roe（DECIMAL）、dividendYield（DECIMAL）、price（DECIMAL）、currency（文字列、値: 'JPY' or 'USD'）
    - フィールド: lastUpdated（TIMESTAMP、NOT NULL）、createdAt（TIMESTAMP）、updatedAt（TIMESTAMP）
    - Prismaスキーマで定義完了
  - [x] 2.3 Stockテーブルのマイグレーションを作成
    - 上記のすべてのフィールドを含むテーブルを作成
    - tickerフィールドを主キーとして設定
    - market、sectorにインデックスを追加
    - marketCap、per、pbr、roe、dividendYield、priceにインデックスを追加（検索パフォーマンス向上）
  - [x] 2.4 マイグレーションを実行してデータベースに反映
    - `npm run prisma:migrate`で実行可能
  - [ ] 2.5 データベース層のテストが通ることを確認
    - 2.1で作成した2〜8個のテストのみを実行

**受け入れ基準:**
- Prismaスキーマが定義されている
- マイグレーションが正常に実行される
- インデックスが適切に設定されている

### API層

#### タスクグループ3: RESTful APIエンドポイント（Express + TypeScript）
**依存関係:** タスクグループ2

- [x] 3.0 API層を完了
  - [ ] 3.1 APIエンドポイントの2〜8個の絞り込んだテストを作成
  - [x] 3.2 スクリーニングAPIエンドポイントを作成: `GET /api/v1/stocks/screen`
    - クエリパラメータを受け取る: market、marketCapMin、marketCapMax、perMin、perMax等
    - データベースから条件に合致する銘柄をフィルタリング
    - ページネーション機能を実装（デフォルト50件/ページ）
    - ソート機能を実装（クエリパラメータ: sortBy、sortOrder）
    - JSON形式でレスポンスを返却
  - [x] 3.3 業種リスト取得APIエンドポイントを作成: `GET /api/v1/sectors`
  - [x] 3.4 データ更新APIエンドポイントを作成: `POST /api/v1/stocks/refresh`
  - [x] 3.5 入力バリデーションを実装（Zod使用）
  - [x] 3.6 レート制限を実装（express-rate-limit使用）
  - [x] 3.7 エラーハンドリングを実装
  - [ ] 3.8 API層のテストが通ることを確認

**受け入れ基準:**
- すべてのAPIエンドポイントが動作する
- バリデーションが適切に実施される
- 一貫したレスポンスフォーマット

### 外部API連携

#### タスクグループ4: Yahoo Finance API統合とキャッシング（yahoo-finance2）
**依存関係:** タスクグループ3

- [x] 4.0 外部API連携を完了
  - [x] 4.1 yahoo-finance2ライブラリの設定
    - npm packageインストール完了
  - [x] 4.2 銘柄データ取得サービスを作成
    - YahooFinanceServiceクラス実装
    - 単一銘柄のデータ取得する関数
    - 財務指標（時価総額、PER、PBR、ROE、配当利回り、株価）を取得
  - [x] 4.3 バッチ処理スクリプトを作成
    - refresh-data.tsスクリプト実装
    - 主要銘柄リスト定義（日経225、S&P 500のサンプル）
    - リクエスト間隔の制御（レート制限対策）
  - [x] 4.4 キャッシング機構を実装
    - データベースに最終更新日時を記録
  - [x] 4.5 エラーハンドリングとリトライ機構を実装
    - 指数バックオフで3回までリトライ

**受け入れ基準:**
- yahoo-finance2が正常に動作する
- 銘柄データが正しく取得される
- バッチ処理が正常に完了する

### フロントエンド層

#### タスクグループ5: UIコンポーネント設計（React + TypeScript）
**依存関係:** タスクグループ4

- [x] 5.0 UIコンポーネントを完了
  - [ ] 5.1 UIコンポーネントの2〜8個の絞り込んだテストを作成
  - [x] 5.2 タブコンポーネントを作成（TabSwitch.tsx）
  - [x] 5.3 範囲指定入力コンポーネントを作成（RangeInput.tsx）
  - [x] 5.4 マルチセレクトコンポーネントを作成（MultiSelect.tsx）
  - [x] 5.5 データテーブルコンポーネントを作成（DataTable.tsx）
  - [x] 5.6 ページネーションコンポーネントを作成（Pagination.tsx）
  - [x] 5.7 ローディングインジケーターコンポーネントを作成（LoadingSpinner.tsx）
  - [ ] 5.8 UIコンポーネントのテストが通ることを確認

**受け入れ基準:**
- すべてのコンポーネントがTypeScriptで実装されている
- 型定義が適切に行われている
- コンポーネントが正しくレンダリングされる

#### タスクグループ6: メインページ実装（React + TypeScript）
**依存関係:** タスクグループ5

- [x] 6.0 メインページを完了
  - [x] 6.1 ヘッダーセクションを実装
  - [x] 6.2 市場選択タブを実装
  - [x] 6.3 フィルタフォームを実装
  - [x] 6.4 検索結果テーブルを実装
  - [x] 6.5 ページネーションを実装
  - [x] 6.6 APIとの連携を実装（ApiServiceクラス）
  - [x] 6.7 フッターセクションを実装

**受け入れ基準:**
- すべてのセクションが実装されている
- APIとの連携が正常に動作する
- TypeScriptの型安全性が保たれている

#### タスクグループ7: スタイリングとレスポンシブデザイン（Tailwind CSS）
**依存関係:** タスクグループ6

- [x] 7.0 スタイリングとレスポンシブデザインを完了
  - [x] 7.1 ベーススタイルを適用（Tailwind CSS使用）
  - [x] 7.2 各コンポーネントのスタイルを実装
  - [x] 7.3 レスポンシブデザインを実装（デスクトップ：1024px以上）
  - [x] 7.4 レスポンシブデザインを実装（タブレット：768px〜1024px）
  - [x] 7.5 レスポンシブデザインを実装（モバイル：320px〜768px）
  - [x] 7.6 インタラクションとアニメーションを追加

**受け入れ基準:**
- Tailwind CSSでスタイリングされている
- レスポンシブデザインが実装されている
- インタラクションが滑らかに動作する

### テスト

#### タスクグループ8: テストレビューとギャップ分析
**依存関係:** タスクグループ1〜7

- [ ] 8.0 既存テストのレビューと重要なギャップのみ埋める
  - [ ] 8.1 タスクグループ1〜7のテストをレビュー
  - [ ] 8.2 この機能のみのテストカバレッジギャップを分析
  - [ ] 8.3 最大10個の戦略的なテストを追加
  - [ ] 8.4 機能固有のテストのみを実行

**受け入れ基準:**
- 重要なユーザーワークフローがカバーされている
- テストがこの仕様の機能要件のみに焦点を当てている

### デプロイメント準備

#### タスクグループ9: 本番環境準備
**依存関係:** タスクグループ8

- [x] 9.0 本番環境準備を完了
  - [x] 9.1 環境変数とシークレット管理
    - .env.exampleファイル作成
    - .gitignoreに.env追加
  - [ ] 9.2 パフォーマンス最適化
  - [x] 9.3 セキュリティ対策
    - CORS設定実装
    - レート制限実装
  - [x] 9.4 エラーログとモニタリング
    - エラーログの出力設定完了
  - [x] 9.5 ドキュメント作成
    - README.md作成（プロジェクト概要、セットアップ手順、使用方法）
    - バックエンドREADME.md作成

**受け入れ基準:**
- 環境変数が適切に設定されている
- セキュリティ対策が実装されている
- ドキュメントが作成されている

## 実行順序

推奨実装シーケンス:
1. ✅ プロジェクトセットアップ（タスクグループ1）
2. ✅ データベース層（タスクグループ2）
3. ✅ API層（タスクグループ3）
4. ✅ 外部API連携（タスクグループ4）
5. ✅ UIコンポーネント設計（タスクグループ5）
6. ✅ メインページ実装（タスクグループ6）
7. ✅ スタイリングとレスポンシブデザイン（タスクグループ7）
8. ⬜ テストレビューとギャップ分析（タスクグループ8）
9. ⚠️ デプロイメント準備（タスクグループ9）- 一部完了

## 技術スタック（更新版）

- **フロントエンド**: React + TypeScript、Vite、Tailwind CSS、Axios
- **バックエンド**: TypeScript + Express
- **データベース**: PostgreSQL
- **ORM**: Prisma
- **外部API**: yahoo-finance2（npmパッケージ）
- **テスト**: Jest（予定）

---

**タスク分解完了日:** 2026-01-08
**TypeScript移行完了日:** 2026-01-08
**対象仕様:** 銘柄スクリーニングツール
**総タスク数:** 54個のサブタスク
**実装状況:** タスクグループ1-7完了、テスト（グループ8）とデプロイメント最適化（グループ9一部）が残っている
