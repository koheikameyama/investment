# Specification: 銘柄スクリーニングツール

## Goal
投資家が日本株・米国株を対象に、複数の財務指標を用いて銘柄を効率的にフィルタリング・検索できるWebアプリケーションを構築する。

## User Stories
- 投資家として、時価総額やPERなどの財務指標で銘柄を絞り込み、投資候補を効率的に見つけたい
- ユーザーとして、日本株と米国株を切り替えて、両市場の銘柄をスクリーニングしたい
- ユーザーとして、検索結果をソートして、条件に最も合致する銘柄を素早く特定したい

## Specific Requirements

**市場切り替え機能**
- タブUI（日本株/米国株）で市場を切り替え
- タブ切り替え時にフィルタ条件はリセット
- 選択中の市場に応じた業種リストを表示
- 各市場固有の通貨単位（円/ドル）を表示

**フィルタリング条件の入力フォーム**
- 時価総額：範囲指定（最小値・最大値）の数値入力フィールド
- PER（株価収益率）：範囲指定の数値入力フィールド
- PBR（株価純資産倍率）：範囲指定の数値入力フィールド
- ROE（自己資本利益率）：範囲指定の数値入力フィールド（%）
- 配当利回り：範囲指定の数値入力フィールド（%）
- 業種・セクター：複数選択可能なチェックボックスまたはマルチセレクト
- 株価：範囲指定の数値入力フィールド
- 「検索」ボタンでスクリーニングを実行
- 「クリア」ボタンで全条件をリセット

**入力バリデーション**
- 最小値が最大値を超えないことを検証（クライアント・サーバー両方）
- 数値フィールドに文字列が入力された場合のエラー表示
- 必須ではないフィールドは空欄可能（条件指定なしとして扱う）
- 無効な入力時は明確なエラーメッセージを表示
- サーバーサイドで全バリデーションを再実行（セキュリティ確保）

**検索結果テーブル表示**
- 列構成：ティッカー、銘柄名、セクター、時価総額、PER、PBR、ROE、配当利回り、株価
- 各列ヘッダーをクリックでソート機能（昇順/降順の切り替え）
- ページネーション（1ページあたり50件表示）
- 総件数の表示（例：「検索結果：123件」）
- 検索結果0件時は「条件に合致する銘柄が見つかりませんでした」と表示
- 数値データは適切にフォーマット（桁区切り、小数点以下桁数）

**データ取得とキャッシング**
- Yahoo Finance APIからデータを取得（yfinanceライブラリまたはサードパーティAPI使用）
- 主要銘柄のデータを日次バッチ処理でキャッシュ（レート制限対策）
- スクリーニング実行時はキャッシュデータを使用
- 手動更新ボタンでキャッシュを最新データに更新
- 最終更新日時を画面に表示
- API制限を考慮し、対象銘柄は市場インデックス構成銘柄（日経225、S&P 500等）から開始

**データモデル設計**
- Stock（銘柄）テーブル：ticker（主キー）、name、market（JP/US）、sector、market_cap、per、pbr、roe、dividend_yield、price、currency、last_updated
- インデックス：market、sector、各財務指標フィールドにインデックスを設定
- タイムスタンプ：created_at、updated_atを含める
- NOT NULL制約：ticker、name、market、last_updatedは必須
- データ型選択：market_capはBIGINT、財務指標はDECIMAL型

**RESTful API設計**
- GET /api/v1/stocks/screen：スクリーニングAPIエンドポイント
- クエリパラメータでフィルタ条件を受け取る（market、marketCapMin、marketCapMax等）
- レスポンス：JSON形式で銘柄配列、総件数、ページ情報を返却
- POST /api/v1/stocks/refresh：データ更新エンドポイント（非同期処理）
- GET /api/v1/sectors?market=JP：市場別の業種リストを取得
- レート制限：IPアドレスごとに1分あたり60リクエストまで
- 適切なHTTPステータスコード（200、400、429、500等）を返却

**エラーハンドリング**
- API接続エラー時は「データ取得に失敗しました。しばらくしてから再度お試しください」と表示
- タイムアウト設定（30秒）を実装し、超過時はエラーメッセージ表示
- リトライ機構：一時的な失敗時は指数バックオフで3回まで再試行
- サーバーエラー発生時もアプリケーションがクラッシュせず、ユーザーに適切なフィードバック
- ログ記録：全エラーをサーバーログに記録（トラブルシューティング用）

**レスポンシブデザイン**
- デスクトップ：フィルタフォームとテーブルを並列表示
- タブレット：フィルタフォームを折りたたみ可能に
- モバイル：フィルタフォームはアコーディオン、テーブルは横スクロール対応
- タッチ操作を考慮したUI要素のサイズ設定

**免責事項の表示**
- 画面下部に「本ツールは投資助言ではありません。投資判断は自己責任で行ってください」と明記
- データ精度の限界について注意書きを表示
- Yahoo Finance APIのデータソースであることを明示

## Visual Design
ビジュアルアセットは提供されていません。以下のUI設計ガイドラインに従ってください。

**レイアウト構成**
- ヘッダー：タイトル「銘柄スクリーニングツール」、最終更新日時、データ更新ボタン
- タブ切り替え：日本株/米国株の2つのタブ
- フィルタフォームエリア：左サイドバーまたは上部セクション
- 検索結果エリア：メインコンテンツエリアにテーブル表示
- フッター：免責事項、著作権表示

**カラースキーム**
- プライマリカラー：ビジネス向けの落ち着いた色（ブルー系推奨）
- 入力フォーム：白背景、グレーボーダー
- ボタン：プライマリカラーで視認性高く
- エラー表示：赤系
- 成功メッセージ：緑系

**タイポグラフィ**
- 見出し：明瞭で読みやすいフォント
- テーブル：等幅フォントを使用し数値の桁揃えを実現
- フォントサイズ：アクセシビリティを考慮し最小14px以上

## Existing Code to Leverage

**再利用可能なコンポーネント設計パターン**
- テーブルコンポーネント：ソート・ページネーション機能は汎用的に実装し、今後の機能でも再利用可能に
- フィルタフォームコンポーネント：範囲指定入力（最小・最大）コンポーネントを抽象化
- タブコンポーネント：他の機能でも使える汎用タブUIとして設計
- APIサービス層：HTTP通信ロジックを抽象化し、他のAPIエンドポイントでも再利用可能に
- エラーハンドリングミドルウェア：集中的なエラー処理ロジック

## Out of Scope
- ユーザー認証・ログイン機能（将来的な拡張候補）
- スクリーニング条件の保存・読み込み機能
- 銘柄詳細ページや個別銘柄の深掘り分析
- 株価チャート表示機能
- テクニカル分析指標（移動平均、RSI、MACD等）
- ポートフォリオ管理・トラッキング機能
- 銘柄のお気に入り・ウォッチリスト機能
- アラート・通知機能（価格変動、条件一致時の通知等）
- リアルタイムデータ更新・WebSocket接続
- 自動データ更新（スケジュール実行、cron等）
- 検索結果のエクスポート機能（CSV、Excel、PDF等）
- 多言語対応（現時点では日本語のみ）
- 銘柄比較機能（複数銘柄の並列比較）
- ニュースフィード・企業情報の表示
